<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF‚Äë8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservations</title>

    <!-- Bootstrap¬†5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">
</head>
<body>
<div class="container mt-5">

    <h1 class="mb-4 text-center">Reservations</h1>

    <!-- √ºst aksiyon butonlarƒ± -->
    <div class="d-flex justify-content-end mb-3 gap-2">
        <form action="/optimize" method="post" class="m-0">
            <button type="submit" class="btn btn-primary">Optimize Routes</button>
        </form>

        <button class="btn btn-success" onclick="showAddModal()">+ Add Reservation</button>
        <button class="btn btn-danger"  onclick="deleteSelected()">üóëÔ∏è¬†Delete¬†Selected</button>
        <button class="btn btn-secondary" onclick="exportTableToCSV('reservations.csv')">‚¨áÔ∏è¬†Export CSV</button>
    </div>

    <!-- tablo -->
    <table class="table table-bordered table-striped align-middle">
        <thead class="table-dark text-center">
        <tr>
            <th><input id="selectAll" type="checkbox" onchange="toggleSelectAll(this)"></th>
            <th>ID</th>
            <th>Customer</th>
            <th>Tour</th>
            <!-- Burayƒ± Option ‚Üí Phone olarak g√ºncelledik -->
            <th>Phone</th>
            <th>Pickup</th>
            <th>District</th>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="r : ${reservations}">
            <td class="text-center">
                <input class="reservation-checkbox form-check-input" th:value="${r.id}" type="checkbox">
            </td>
            <td th:text="${r.id}"></td>
            <td th:text="${r.customer}"></td>
            <td th:text="${r.tour}"></td>
            <!-- Burayƒ± r.optionName ‚Üí r.phone olarak deƒüi≈ütirdik -->
            <td th:text="${r.phone}"></td>
            <td th:text="${r.pickup}"></td>
            <td th:text="${r.district}"></td>
            <td th:text="${r.date}"></td>
            <td th:text="${r.time}"></td>
            <td th:text="${r.status}"></td>
            <td class="text-center">
                <a class="btn btn-sm btn-warning"
                   th:href="@{'/reservations/edit/' + ${r.id}}">Edit</a>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!--  Bootstrap¬†bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    /* Select / bulk delete */
    function toggleSelectAll(master) {
        document.querySelectorAll('.reservation-checkbox')
            .forEach(cb => cb.checked = master.checked);
    }
    function deleteSelected() {
        const ids = [...document.querySelectorAll('.reservation-checkbox:checked')]
            .map(cb => cb.value);
        if (!ids.length) { alert('Select at least one!'); return; }
        if (!confirm('Delete selected reservations?')) return;
        Promise.all(ids.map(id =>
            fetch(`/api/reservations/${id}`, {method: 'DELETE'})
                .then(r => r.ok || Promise.reject(id))
        )).then(() => location.reload())
            .catch(badId => alert(`Failed to delete id=${badId}`));
    }

    /* Add modal */
    const addModalEl = document.getElementById('addReservationModal');
    const addModal   = new bootstrap.Modal(addModalEl);
    function showAddModal() { addModal.show(); }
    addModalEl.querySelector('form').addEventListener('submit', e => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        fetch('/api/reservations', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        }).then(r => r.ok ? r.json() : Promise.reject())
            .then(() => { addModal.hide(); location.reload(); })
            .catch(() => alert('‚ùå¬†Error while saving!'));
    });

    /* Frontend sƒ±ralama (Tour‚ÜíDistrict‚ÜíDate‚ÜíTime) */
    document.addEventListener('DOMContentLoaded', () => {
        const tbody = document.querySelector('table tbody');
        const rows  = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
            const tourA = a.children[3].textContent.trim().toLowerCase();
            const tourB = b.children[3].textContent.trim().toLowerCase();
            if (tourA !== tourB) return tourA.localeCompare(tourB);

            const distA = a.children[6].textContent.trim().toLowerCase();
            const distB = b.children[6].textContent.trim().toLowerCase();
            if (distA !== distB) return distA.localeCompare(distB);

            const dateA = new Date(a.children[7].textContent);
            const dateB = new Date(b.children[7].textContent);
            if (dateA - dateB) return dateA - dateB;

            const timeA = a.children[8].textContent.trim();
            const timeB = b.children[8].textContent.trim();
            return timeA.localeCompare(timeB);
        });
        rows.forEach(r => tbody.appendChild(r));
    });

    /* CSV export */
    function exportTableToCSV(filename) {
        const rows = Array.from(document.querySelectorAll('table tr'));
        const csv = rows.map(row => {
            const cols = Array.from(row.querySelectorAll('th, td'))
                .filter((_,i) => i!==0) // checkbox h√ºcresini atla
                .map(cell => `"${cell.textContent.trim().replace(/"/g,'""')}"`);
            return cols.join(',');
        }).join('\r\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
    }
</script>

<!-- Add Reservation Modal -->
<div id="addReservationModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form>
                <div class="modal-header">
                    <h5 class="modal-title">New Reservation</h5>
                    <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
                </div>
                <div class="modal-body row g-2">
                    <div class="col-12">
                        <label class="form-label">Customer</label>
                        <input name="customer" class="form-control" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Tour</label>
                        <input name="tour" class="form-control" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Phone</label>
                        <input name="phone" class="form-control">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Pickup Location</label>
                        <input name="pickup" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">District</label>
                        <input name="district" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date</label>
                        <input name="date" type="date" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Time</label>
                        <input name="time" type="time" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" type="submit">Save</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
</html>
